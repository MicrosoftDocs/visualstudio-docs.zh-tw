---
title: Debug 多執行緒應用程式
description: 使用 [執行緒] 視窗和 [調試位置] 工具列來進行 debug Visual Studio
ms.date: 02/14/2020
ms.topic: how-to
dev_langs:
- CSharp
- VB
- FSharp
- C++
helpviewer_keywords:
- multithreaded debugging, tutorial
- tutorials, multithreaded debugging
ms.assetid: adfbe002-3d7b-42a9-b42a-5ac0903dfc25
author: mikejo5000
ms.author: mikejo
manager: jillfra
ms.workload:
- multiple
ms.openlocfilehash: 33375a8970638765d02a94e6e3e9cd8afc1a0fe7
ms.sourcegitcommit: c076fe12e459f0dbe2cd508e1294af14cb53119f
ms.translationtype: MT
ms.contentlocale: zh-TW
ms.lasthandoff: 06/25/2020
ms.locfileid: "85348648"
---
# <a name="walkthrough-debug-a-multithreaded-app-using-the-threads-window-c-visual-basic-c"></a>逐步解說：使用執行緒視窗（c #、Visual Basic、c + +）進行多執行緒應用程式的偵錯工具

數個 Visual Studio 的使用者介面專案可協助您進行多執行緒應用程式的偵錯工具。 本文介紹 [程式碼編輯器] 視窗、[偵錯工具**位置**] 工具列和 [**執行緒**] 視窗中的多執行緒偵錯工具功能。 如需其他工具以進行多執行緒應用程式的詳細資訊，請參閱[開始對多執行緒應用程式](../debugger/get-started-debugging-multithreaded-apps.md)進行偵測。

完成本教學課程只需要幾分鐘的時間，並讓您瞭解多執行緒應用程式的基本概念。

## <a name="create-a-multithreaded-app-project"></a>建立多執行緒應用程式專案

建立下列多執行緒應用程式專案，以在本教學課程中使用：

1. 開啟 Visual Studio 並建立新專案。

   ::: moniker range=">=vs-2019"

   如果 [開始] 視窗未開啟，請**選擇 [** 檔案 > **] [啟動視窗]**。

   在 [開始] 視窗中，選擇 [**建立新專案**]。

   在 [建立新專案]**** 視窗的搜尋方塊中輸入或鍵入 ASP.NET**。 接下來，從 [語言] 清單中選擇**c #** 或**c + +** ，然後從 [平臺] 清單中選擇 [ **Windows** ]。 

   套用語言和平臺篩選器之後，請選擇 [**主控台應用程式（.Net Core）** ]，或針對 [c + +]**主控台應用程式**範本，然後選擇 [**下一步]**。

   > [!NOTE]
   > 如果您看不到正確的範本，請移至 [**工具**] [  >  **取得工具和功能 ...**]，這會開啟 Visual Studio 安裝程式。 選擇 [ **.net 桌面開發**] 或 [**使用 c + + 進行桌面開發**] 工作負載，然後選擇 [**修改**]。

   在 [**設定您的新專案**] 視窗中，于 [**專案名稱**] 方塊中鍵入或輸入*MyThreadWalkthroughApp* 。 然後選擇 [**建立**]。

   ::: moniker-end
   ::: moniker range="vs-2017"
   從頂端功能表列中 **，選擇 [** 檔案] [新增] [  >  **New**  >  **專案**]。 在 [**新增專案**] 對話方塊的左窗格中，選擇下列專案：

   - 針對 c # 應用程式，請在 [ **Visual c #**] 下選擇 [ **Windows 桌面**]，然後在中間窗格中選擇 [**主控台應用程式（.NET Framework）**]。
   - 若是 c + + 應用程式，請在 [ **Visual C++**] 底下，選擇 [ **windows 桌面**]，然後選擇 [ **windows 主控台應用程式**]。

   如果您看不到**主控台應用程式（.net Core）** ，或在 c + + 的**主控台應用程式**專案範本中，請移至 [**工具**] [  >  **取得工具和功能 ...**]，這會開啟 Visual Studio 安裝程式。 選擇 [ **.net 桌面開發**] 或 [**使用 c + + 進行桌面開發**] 工作負載，然後選擇 [**修改**]。

   然後，輸入類似*MyThreadWalkthroughApp*的名稱，然後按一下 **[確定]**。

   選取 [確定]。
   ::: moniker-end

   新的主控台專案隨即出現。 建立專案之後，就會出現原始程式檔。 根據您所選擇的語言，來源檔案可能稱為*Program.cs*、 *MyThreadWalkthroughApp*或*Module1*。

1. 將原始程式檔中的程式碼，取代為[開始進行多執行緒應用程式](../debugger/get-started-debugging-multithreaded-apps.md)的 c # 或 c + + 範例程式碼。

1. 選取 **[** 檔案] [  >  **全部儲存**]。

## <a name="start-debugging"></a>開始偵錯

1. 在原始程式碼中尋找下列程式程式碼：

   ```csharp
   Thread.Sleep(3000);
   Console.WriteLine();
   ```

   ```C++
   Thread::Sleep(3000);
   Console.WriteLine();
   ```

1. `Console.WriteLine();`按一下左側裝訂邊，或選取行並按**F9**鍵，在行上設定中斷點。

   中斷點會在程式程式碼旁邊的左邊裝訂邊中顯示為紅色圓圈。

1. 選取 [ **Debug**] [  >  **開始調試**]，或按**F5**。

   應用程式會以 debug 模式啟動，並在中斷點暫停。

1. 在中斷模式中，選取 [**調試**程式] [ **Threads**  >  **Windows**  >  **執行緒**] 來開啟 [執行緒] 視窗。 您必須在 [調試] 會話中，才能開啟或查看**執行緒**和其他調試時間視窗。

## <a name="examine-thread-markers"></a>檢查執行緒標記

1. 在原始程式碼中，找出程式碼 `Console.WriteLine();` 行。

   1. 在 [**執行緒**] 視窗中按一下滑鼠右鍵，然後從**功能表選取 [在來源**![中顯示](../debugger/media/dbg-multithreaded-show-threads.png "ThreadMarker")執行緒]。

   源程式碼旁邊的裝訂邊現在會顯示*執行緒標記*圖示![執行緒標記](../debugger/media/dbg-thread-marker.png "執行緒標記")。 執行緒標記表示執行緒會停在這個位置上。 如果位置上有多個已停止的執行緒，則會顯示![多個執行緒](../debugger/media/dbg-multithreaded-show-threads.png "多執行緒")圖示。

1. 將指標移到執行緒標記上。 [資料提示] 隨即出現，其中顯示已停止的執行緒或執行緒的名稱和執行緒 ID 編號。 執行緒名稱可能是 `<No Name>` 。

   >[!TIP]
   >若要協助識別無指定的執行緒，您可以在 [**執行緒**] 視窗中將它們重新命名。 以滑鼠右鍵按一下執行緒，然後選取 [**重新命名**]。

1. 以滑鼠右鍵按一下原始程式碼中的執行緒標記，以在快捷方式功能表上查看可用的選項。

## <a name="flag-and-unflag-threads"></a>將執行緒加上旗標和取消旗標

您可以為執行緒加上旗標，以追蹤您想要特別注意的執行緒。

從原始程式碼編輯器或 [**執行緒**] 視窗中，將執行緒加上旗標和解除標記。 從 [**調試位置**] 或 [**執行緒**] 視窗工具列選擇是否只顯示已標記的執行緒或所有線程。 從任何位置所做的選擇會影響所有位置。

### <a name="flag-and-unflag-threads-in-source-code"></a>在原始程式碼中為執行緒加上旗標和解除標記

1. 選取 [視圖] [工具列] [**流覽**位置] 來開啟 [**偵錯工具位置**] 工具列  >  **Toolbars**  >  ** **。 您也可以在工具列區域中按一下滑鼠右鍵，然後選取 [**調試位置**]。

1. [**偵錯工具位置**] 工具列有三個欄位： [**進程**]、[**執行緒**] 和 [**堆疊框架**]。 下拉 [**執行緒**] 清單，並記下有多少執行緒。 在 [**執行緒**] 清單中，目前執行的執行緒會以 **>** 符號標示。

1. 在原始程式碼視窗中，將滑鼠停留在裝訂邊的執行緒標記圖示上，然後選取資料提示方塊中的旗標圖示（或其中一個空白旗標圖示）。 旗標圖示會變成紅色。

   您也可以用滑鼠右鍵按一下執行緒標記圖示，指向 [**旗**標]，然後從快捷方式功能表選取要加上旗標的執行緒。

1. 在 [**調試位置**] 工具列上，選取 [**執行緒**] 欄位右邊的 [**僅顯示標示**為旗標的執行緒] 圖示顯示加上旗![標的執行緒](../debugger/media/dbg-threads-show-flagged.png "顯示加上旗標的執行緒")。 除非有一或多個執行緒標示為灰色，否則圖示會呈現灰色。

   只有加上旗標的執行緒現在會出現在工具列的 [**執行緒**] 下拉式清單中。 若要再次顯示所有線程，請再次選取 [**僅顯示已標記的執行緒**] 圖示。

   >[!TIP]
   >在標記一些執行緒之後，您可以將游標放在程式碼編輯器中，按一下滑鼠右鍵，然後選取 [執行加上旗**標的執行緒到游標處**]。 請務必選擇所有加上旗標的執行緒都會到達的程式碼。 **對游標執行**加上旗標的執行緒會暫停所選程式程式碼上的執行緒，讓您更輕鬆地藉由[凍結和解凍執行緒](#bkmk_freeze)來控制執行順序。

1. 若要切換目前執行中線程的已旗標或未標記狀態，請選取 [**只顯示已標記的執行緒**] 按鈕左邊的單一旗**標 [切換目前的執行緒標記狀態**] 工具列按鈕。 標記目前線程對於在只顯示已標記的執行緒時尋找目前的執行緒很有用。

1. 若要取消執行緒的旗標，請將滑鼠停留在原始程式碼中的執行緒標記上，然後選取紅色旗標圖示加以清除，或以滑鼠右鍵按一下執行緒標記並選取 [取消**標記**]。

### <a name="flag-and-unflag-threads-in-the-threads-window"></a>[執行緒] 視窗中的旗標和解除標記執行緒

在 [**執行緒**] 視窗中，加上旗標的執行緒旁邊會有紅色旗標圖示，而未標示的執行緒（如果有顯示的話）則具有空白圖示。

![執行緒視窗](../debugger/media/dbg-threads-window.png "執行緒視窗")

選取旗標圖示，根據其目前的狀態，將執行緒狀態變更為 [已標記] 或 [未標示]。

您也可以在行上按一下滑鼠右鍵，然後從快捷方式功能表選取 [**旗**標]、[取消**標記**] 或 [取消**標記所有線程**]。

[**執行緒**] 視窗工具列也有 [**僅顯示已標記的執行緒**] 按鈕，也就是兩個旗標圖示的 righthand 之一。 其運作方式與 [**調試位置**] 工具列上的按鈕相同，而任一按鈕則控制兩個位置中的顯示。

### <a name="other-threads-window-features"></a>其他執行緒視窗功能

在 [**執行緒**] 視窗中，選取任何資料行的標頭，以依據該資料行來排序執行緒。 再次選取以反轉排序次序。 如果顯示所有的執行緒，選取 [旗標] 圖示資料行會依標示或未標記的狀態來排序執行緒。

[**執行緒**] 視窗的第二個數據行（不含標頭）是 [**目前線程**] 資料行。 此資料行中的黃色箭號會標示目前的執行點。

[**位置**] 欄會顯示每個執行緒在原始程式碼中出現的位置。 選取 [**位置**] 專案旁邊的展開箭號，或將滑鼠停留在該專案上方，以顯示該執行緒的部分呼叫堆疊。

>[!TIP]
>如需執行緒之呼叫堆疊的圖形化視圖，請使用 [[平行堆疊](../debugger/using-the-parallel-stacks-window.md)] 視窗。 若要開啟視窗，請在進行調試時，選取 [**調試** >  **Windows**  >  **平行堆疊**]。

除了**旗**標、取消**標記**和取消**標記所有線程**，**執行緒**視窗專案的滑鼠右鍵操作功能表具有：

- [**在來源中顯示執行緒**] 按鈕。
- **十六進位顯示**，會將 [**執行緒**] 視窗中的**執行緒識別碼**從十進位變更為十六進位格式。
- [切換至執行緒](#switch-to-another-thread)，這會立即將執行切換至該執行緒。
- [**重新命名**]，可讓您變更執行緒名稱。
- [凍結和解除](#bkmk_freeze)凍結命令。

## <a name="freeze-and-thaw-thread-execution"></a><a name="bkmk_freeze"></a>凍結和解除凍結執行緒執行

您可以凍結並解除凍結，或暫停和繼續執行緒，以控制執行緒執行工作的順序。 凍結和解除凍結執行緒可協助您解決並行問題，例如鎖死和競爭條件。

> [!TIP]
> 若要追蹤單一執行緒，而不凍結其他執行緒，這也是常見的偵錯工具案例，請參閱[開始對多執行緒應用程式進行偵錯工具](../debugger/get-started-debugging-multithreaded-apps.md#bkmk_follow_a_thread)。

**凍結和解除凍結執行緒：**

1. 在 [**執行緒**] 視窗中，以滑鼠右鍵按一下任何執行緒，然後選取 [**凍結**]。 [**目前線程**] 資料行中的**暫停**圖示表示執行緒已凍結。

1. 在 [**執行緒**] 視窗工具列中選取 [資料**行**]，然後選取 [**擱置計數**] 以顯示 [**暫停計數**] 資料行。 凍結執行緒的暫停計數值是**1**。

1. 以滑鼠右鍵按一下凍結的執行緒，然後選取 [**解除凍結**]。

   **暫停**圖示就會消失，而且 [已**暫停的計數**] 值會變更為**0**。

## <a name="switch-to-another-thread"></a>切換至另一個執行緒

當您嘗試切換至另一個執行緒時，您可能會看到 **[應用程式處於中斷模式**] 視窗。 這個視窗會告訴您，執行緒沒有目前偵錯工具可以顯示的任何程式碼。 例如，您可能正在偵錯工具代碼，但執行緒是機器碼。 此視窗會提供解決問題的建議。

**若要切換至另一個執行緒：**

1. 在 [**執行緒**] 視窗中，記下目前線程識別碼，也就是在 [**目前線程**] 資料行中具有黃色箭號的執行緒。 您會想要切換回此執行緒，以繼續執行您的應用程式。

1. 以滑鼠右鍵按一下不同的執行緒，然後從內容功能表中選取 [**切換至執行緒**]。

1. 觀察 [**執行緒**] 視窗中的黃色箭號位置已變更。 原始的目前線程標記也會保留，做為大綱。

   在 [程式碼來源編輯器] 中，查看執行緒標記上的工具提示，然後在 [**偵錯工具位置**] 工具列上的 [**執行緒**] 下拉式清單中，尋找該清單。 請注意，目前的執行緒也已在此變更。

1. 在 [**調試位置**] 工具列上，從 [**執行緒**] 清單中選取不同的執行緒。 請注意，目前的執行緒也會在其他兩個位置變更。

1. 在原始程式碼編輯器中，以滑鼠右鍵按一下執行緒標記，指向 [**切換至執行緒**]，然後從清單中選取另一個執行緒。 請注意，目前的執行緒在三個位置中都有變更。

使用原始程式碼中的執行緒標記時，您只能切換到在該位置停止的執行緒。 使用 [執行緒]**** 視窗和 [偵錯位置]**** 工具列時，您可以切換至任何執行緒。

您現在已瞭解多執行緒應用程式的調試基本概念。 您可以使用 [**執行緒**] 視窗、[**偵錯工具位置**] 工具列中的 [**執行緒**] 清單，或原始程式碼編輯器中的執行緒標記，來觀察、旗標和解除標記，以及凍結和解除凍結執行緒。

## <a name="see-also"></a>另請參閱
- [Debug 多執行緒應用程式](../debugger/debug-multithreaded-applications-in-visual-studio.md)
- [如何：在偵錯時切換到另一個執行緒](../debugger/how-to-switch-to-another-thread-while-debugging.md)
