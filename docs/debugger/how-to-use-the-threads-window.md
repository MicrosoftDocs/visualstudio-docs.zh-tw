---
title: 將多執行緒應用程式進行偵錯工具
description: 在 Visual Studio 中使用 [執行緒] 視窗和 [調試位置] 工具列進行調試
ms.date: 02/14/2020
ms.topic: how-to
dev_langs:
- CSharp
- VB
- FSharp
- C++
helpviewer_keywords:
- multithreaded debugging, tutorial
- tutorials, multithreaded debugging
ms.assetid: adfbe002-3d7b-42a9-b42a-5ac0903dfc25
author: mikejo5000
ms.author: mikejo
manager: jillfra
ms.workload:
- multiple
ms.openlocfilehash: 33375a8970638765d02a94e6e3e9cd8afc1a0fe7
ms.sourcegitcommit: 6cfffa72af599a9d667249caaaa411bb28ea69fd
ms.translationtype: MT
ms.contentlocale: zh-TW
ms.lasthandoff: 09/02/2020
ms.locfileid: "85348648"
---
# <a name="walkthrough-debug-a-multithreaded-app-using-the-threads-window-c-visual-basic-c"></a>逐步解說：使用執行緒視窗對多執行緒應用程式進行 (c #、Visual Basic、c + +) 

數個 Visual Studio 的使用者介面專案可協助您進行多執行緒應用程式的偵錯工具。 本文介紹 [程式碼編輯器] 視窗、[偵錯工具 **位置** ] 工具列和 [ **執行緒** ] 視窗中的多執行緒調試功能。 如需其他工具來偵測多執行緒應用程式的詳細資訊，請參閱 [開始對多執行緒](../debugger/get-started-debugging-multithreaded-apps.md)應用程式進行偵錯工具。

完成本教學課程只需要幾分鐘的時間，並讓熟悉您瞭解多執行緒應用程式的基本概念。

## <a name="create-a-multithreaded-app-project"></a>建立多執行緒應用程式專案

建立下列多執行緒應用程式專案，以在本教學課程中使用：

1. 開啟 Visual Studio 並建立新專案。

   ::: moniker range=">=vs-2019"

   如果 [開始] 視窗未開啟，請 **選擇 [** 檔案 > **開始視窗]**。

   在 [開始] 視窗中，選擇 [ **建立新專案**]。

   在 [建立新專案]**** 視窗的搜尋方塊中輸入或鍵入 ASP.NET**。 接下來，從 [語言] 清單中選擇 **c #** 或 **c + +** ，然後從 [平臺] 清單中選擇 [ **Windows** ]。 

   套用語言和平臺篩選器之後，請選擇 ** ( .Net Core) 的主控台應用程式 ** ，或針對 c + + **主控台應用程式** 範本，然後選擇 **[下一步]**。

   > [!NOTE]
   > 如果您沒有看到正確的範本，請移至 [**工具**  >  **取得工具和功能**]，這會開啟 Visual Studio 安裝程式。 選擇 [ **.net 桌面開發** ] 或 [ **使用 c + + 的桌面開發** ] 工作負載，然後選擇 [ **修改**]。

   在 [**設定您的新專案**] 視窗中，于 [**專案名稱**] 方塊中輸入或輸入*MyThreadWalkthroughApp* 。 然後，選擇 [ **建立**]。

   ::: moniker-end
   ::: moniker range="vs-2017"
   從頂端功能表列中 **，選擇 [** 檔案  >  **新增**  >  **專案**]。 在 [ **新增專案** ] 對話方塊的左窗格中，選擇下列專案：

   - 針對 c # 應用程式，請選擇 [ **Visual c #**] 底下的 [ **Windows 桌面**]，然後在中間窗格中選擇 [ **主控台應用程式 ( .NET Framework) **]。
   - 若是 c + + 應用程式，請在 [ **Visual C++**] 下，選擇 [ **windows 桌面**]，然後選擇 [ **windows 主控台應用程式**]。

   如果您沒有看到**主控台應用程式 ( .net Core) **或針對 c + +，**主控台應用程式**專案範本，請移至 [**工具**  >  **取得工具和功能**]，這會開啟 Visual Studio 安裝程式。 選擇 [ **.net 桌面開發** ] 或 [ **使用 c + + 的桌面開發** ] 工作負載，然後選擇 [ **修改**]。

   然後，輸入 *MyThreadWalkthroughApp* 之類的名稱，然後按一下 **[確定]**。

   選取 [確定]  。
   ::: moniker-end

   新的主控台專案隨即出現。 建立專案之後，會出現原始程式檔。 根據您所選擇的語言，來源檔案可能會稱為 *Program.cs*、 *MyThreadWalkthroughApp .cpp*或 *Module1*。

1. 將原始程式檔中的程式碼取代為開始對 [多執行緒應用程式進行偵錯工具](../debugger/get-started-debugging-multithreaded-apps.md)的 c # 或 c + + 範例程式碼。

1. 選取 **[**  >  **全部儲存**]。

## <a name="start-debugging"></a>開始偵錯

1. 在原始程式碼中找出下列程式程式碼：

   ```csharp
   Thread.Sleep(3000);
   Console.WriteLine();
   ```

   ```C++
   Thread::Sleep(3000);
   Console.WriteLine();
   ```

1. `Console.WriteLine();`按一下左邊的裝訂邊，或選取該行並按**F9**，在行上設定中斷點。

   中斷點會在程式程式碼旁邊的左邊裝訂邊中顯示為紅色圓圈。

1. 選取 [ **Debug**  >  **開始調試**]，或按**F5**。

   應用程式會在「偵錯工具」模式下啟動，並在中斷點暫停。

1. 在中斷模式中，選取 [ **Threads** **Debug**  >  **Windows**  >  **執行緒**] 以開啟 [執行緒] 視窗。 您必須在調試會話中，才能開啟或查看 **執行緒** 和其他調試時間視窗。

## <a name="examine-thread-markers"></a>檢查執行緒標記

1. 在原始程式碼中，找出這 `Console.WriteLine();` 一行。

   1. 在 [ **執行緒** ] 視窗中按一下滑鼠右鍵，然後從功能表中選取 [ **在**來源 ![中顯示執行緒](../debugger/media/dbg-multithreaded-show-threads.png "ThreadMarker") ]。

   源程式碼旁的裝訂邊現在會顯示 *執行緒標記* 圖示 ![執行緒標記](../debugger/media/dbg-thread-marker.png "執行緒標記")。 執行緒標記表示執行緒會停在這個位置上。 如果位置有一個以上已停止的執行緒，則會出現 ![多個執行緒](../debugger/media/dbg-multithreaded-show-threads.png "多執行緒") 圖示。

1. 將指標移到執行緒標記上。 資料提示隨即出現，其中顯示已停止之執行緒或執行緒的名稱和執行緒識別碼號碼。 執行緒名稱可能是 `<No Name>` 。

   >[!TIP]
   >若要協助識別未指定的執行緒，您可以在 [ **執行緒** ] 視窗中重新命名。 以滑鼠右鍵按一下執行緒，然後選取 [ **重新命名**]。

1. 在原始程式碼中的執行緒標記上按一下滑鼠右鍵，以查看快捷方式功能表上可用的選項。

## <a name="flag-and-unflag-threads"></a>將執行緒加上旗標和取消旗標

您可以為執行緒加上旗標，以追蹤您想要特別注意的執行緒。

從原始程式碼編輯器或 [ **執行緒** ] 視窗中，對執行緒進行旗標和解除標記。 選擇是否只顯示 [ **Debug] 位置** 或 [ **執行緒** ] 視窗工具列中的旗標執行緒或所有線程。 從任何位置所做的選擇會影響所有的位置。

### <a name="flag-and-unflag-threads-in-source-code"></a>在原始程式碼中為執行緒加上旗標和解除標記

1. 選取 [ **Debug Location** **查看**  >  **工具列**的  >  **偵錯工具位置**]，開啟 [偵錯工具位置] 工具列。 您也可以用滑鼠右鍵按一下工具列區域，然後選取 [ **Debug Location**]。

1. [ **偵錯工具位置** ] 工具列有三個欄位： [ **進程**]、[ **執行緒**] 和 [ **堆疊框架**]。 下拉 [ **執行緒** ] 清單，並記下有多少執行緒。 在 [ **執行緒** ] 清單中，目前執行中的執行緒是以 **>** 符號標示。

1. 在 [原始程式碼] 視窗中，將滑鼠停留在裝訂邊的 [執行緒標記] 圖示上方，然後選取 [旗標] 圖示 (或 [資料提示]) 的其中一個空白旗標圖示。 旗標圖示會變成紅色。

   您也可以用滑鼠右鍵按一下 [執行緒標記] 圖示，指向 [ **旗**標]，然後從快捷方式功能表中選取要旗標的執行緒。

1. 在 [**偵錯工具位置**] 工具列上，選取 [**執行緒**] 欄位右邊的 [**僅顯示**加上旗標的往來文章] 圖示![顯示標示的執行緒](../debugger/media/dbg-threads-show-flagged.png "顯示加上旗標的執行緒")。 除非有一或多個執行緒加上旗標，否則圖示會呈現灰色。

   只有旗標的執行緒現在會出現在工具列的 [ **執行緒** ] 下拉式清單中。 若要再次顯示所有線程，請再次選取 [ **僅顯示** 已加上旗標的執行緒] 圖示。

   >[!TIP]
   >在您標示某些執行緒之後，您可以將游標放在程式碼編輯器中、按一下滑鼠右鍵，然後選取 [ **執行標示為執行緒的執行緒] 游標**。 請務必選擇所有標示的執行緒都會到達的程式碼。 **執行** 加上旗標的執行緒，游標會在所選取的程式程式碼上暫停執行緒，讓您可以藉由 [凍結和解除凍結執行緒](#bkmk_freeze)，更輕鬆地控制執行的順序。

1. 若要切換目前正在執行之執行緒的旗標或未標記狀態，請選取 [**僅顯示**已加上旗標的執行緒] 按鈕左邊的單一旗標**切換目前線程標記的狀態**工具列按鈕。 標記目前的執行緒在只顯示旗標的執行緒時尋找目前的執行緒很有用。

1. 若要取消標示執行緒，請將滑鼠停留在原始程式碼中的執行緒標記上，然後選取紅色旗標圖示來清除它，或是以滑鼠右鍵按一下執行緒標記，然後選取 [取消 **標記**]。

### <a name="flag-and-unflag-threads-in-the-threads-window"></a>在 [執行緒] 視窗中將執行緒旗標和解除標記

在 [ **執行緒** ] 視窗中，加上旗標的執行緒旁邊有紅色旗標圖示，而未標記的執行緒（如有顯示）則有空白的圖示。

![執行緒視窗](../debugger/media/dbg-threads-window.png "執行緒視窗")

選取旗標圖示，將執行緒狀態變更為已加上旗標或未標記（視其目前的狀態而定）。

您也可以用滑鼠右鍵按一下線條，然後從快捷方式功能表選取 [旗標]、[取消**標記**] 或 [取消**標示****所有線程**]。

[ **執行緒** ] 視窗工具列也有 [ **顯示標示為僅限執行緒** ] 按鈕，這是兩個旗標圖示的 righthand 之一。 其運作方式與 [ **調試位置** ] 工具列上的按鈕相同，而任一個按鈕控制兩個位置中的顯示。

### <a name="other-threads-window-features"></a>其他執行緒視窗功能

在 [ **執行緒** ] 視窗中，選取任何資料行的標頭，依該資料行排序執行緒。 再次選取以反轉排序次序。 如果顯示所有線程，則選取旗標圖示資料行會依旗標或未標記的狀態來排序執行緒。

[ **執行緒** ] 視窗的第二個數據行 (沒有標頭) 是 **目前的執行緒** 資料行。 此資料行中的黃色箭號會標示目前的執行點。

[ **位置** ] 欄會顯示每個執行緒在原始程式碼中出現的位置。 選取 **位置** 專案旁的展開箭號，或將滑鼠停留在專案上方，以顯示該執行緒的部分呼叫堆疊。

>[!TIP]
>如需執行緒呼叫堆疊的圖形化視圖，請使用 [ [平行堆疊](../debugger/using-the-parallel-stacks-window.md) ] 視窗。 若要在進行調試時開啟視窗，請選取 [ **Debug** >  **Windows**  >  **平行堆疊**]。

除了旗**標、取消標示和取消****標示****所有線程**之外，**執行緒**視窗專案的滑鼠右鍵內容功能表也有：

- [ **在來源中顯示執行緒** ] 按鈕。
- **十六進位顯示**，會將 [**執行緒**] 視窗中的**執行緒識別碼**從十進位變更為十六進位格式。
- [切換至 [執行緒](#switch-to-another-thread)]，立即將執行切換到該執行緒。
- **重新命名**，可讓您變更執行緒名稱。
- [凍結和解除凍結](#bkmk_freeze) 命令。

## <a name="freeze-and-thaw-thread-execution"></a><a name="bkmk_freeze"></a> 凍結和解除凍結執行緒執行

您可以凍結和解除凍結，或暫停和繼續執行緒，以控制執行緒執行工作的順序。 凍結和解除凍結執行緒可協助您解決並行問題，例如鎖死和競爭情形。

> [!TIP]
> 若要在不凍結其他執行緒的情況下追蹤單一執行緒，也就是常見的偵錯工具，請參閱 [開始進行多執行緒應用程式的偵錯工具](../debugger/get-started-debugging-multithreaded-apps.md#bkmk_follow_a_thread)。

**凍結和解除凍結執行緒：**

1. 在 [ **執行緒** ] 視窗中，以滑鼠右鍵按一下任何執行緒，然後選取 [ **凍結**]。 [**目前的執行緒**] 欄中的**暫停**圖示表示執行緒已凍結。

1. 選取 [**執行緒**] 視窗工具列中的 [資料**行**]，然後選取 [**擱置計數**] 以顯示 [**擱置的計數**] 資料行。 凍結執行緒的暫停計數值為 **1**。

1. 以滑鼠右鍵按一下凍結的執行緒，然後選取 [ **解除凍結**]。

   **暫停**圖示就會消失，而**暫停的計數**值會變更為**0**。

## <a name="switch-to-another-thread"></a>切換到另一個執行緒

當您嘗試切換至另一個執行緒時，可能會看到 **應用程式處於中斷模式** 視窗。 這個視窗會告訴您，執行緒沒有目前偵錯工具可以顯示的任何程式碼。 例如，您可能會對 managed 程式碼進行偵錯工具，但執行緒是機器碼。 此視窗提供解決問題的建議。

**若要切換到另一個執行緒：**

1. 在 [ **執行緒** ] 視窗中，記下目前的執行緒識別碼，也就是 **目前線程** 資料行中具有黃色箭號的執行緒。 您會想要切換回此執行緒以繼續您的應用程式。

1. 以滑鼠右鍵按一下不同的執行緒，然後從操作功能表中選取 [ **切換至執行緒** ]。

1. 觀察 [ **執行緒** ] 視窗中的黃色箭號位置已變更。 原始的目前線程標記也會保留為大綱。

   查看程式碼來源編輯器中線程標記的工具提示，以及**偵錯工具位置**工具列上 [**執行緒**] 下拉式清單中的清單。 觀察目前的執行緒也有變更。

1. 在 [ **調試位置** ] 工具列上，從 [ **執行緒** ] 清單中選取不同的執行緒。 請注意，目前的執行緒也會在其他兩個位置中變更。

1. 在 [原始程式碼編輯器] 中，以滑鼠右鍵按一下執行緒標記，指向 [ **切換至執行緒**]，然後從清單中選取另一個執行緒。 觀察目前的執行緒在這三個位置都有變更。

使用原始程式碼中的執行緒標記，您只能切換到在該位置停止的執行緒。 使用 [執行緒]**** 視窗和 [偵錯位置]**** 工具列時，您可以切換至任何執行緒。

您現在已瞭解偵測多執行緒應用程式的基本概念。 您可以使用 [**執行緒**] 視窗、[**偵錯工具位置**] 工具列中的 [**執行緒**] 清單，或原始程式碼編輯器中的執行緒標記，來觀察、旗標和解除標記，以及凍結和解除凍結執行緒。

## <a name="see-also"></a>另請參閱
- [Debug 多執行緒應用程式](../debugger/debug-multithreaded-applications-in-visual-studio.md)
- [如何：在偵錯時切換到另一個執行緒](../debugger/how-to-switch-to-another-thread-while-debugging.md)
