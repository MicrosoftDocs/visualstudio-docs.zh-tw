---
title: 並行視覺化檢視中的執行緒檢視 | Microsoft Docs
description: 瞭解在 [執行緒] 視圖中，您可以識別哪些執行緒在執行區段期間正在執行程式碼。
ms.date: 11/04/2018
ms.topic: conceptual
f1_keywords:
- vs.performance.view.threadblocking
helpviewer_keywords:
- Concurrency Visualizer, Threads View (Parallel Performance)
ms.assetid: 2e441103-a266-407b-88c3-fb58716257a3
author: mikejo5000
ms.author: mikejo
manager: jmartens
ms.workload:
- multiple
ms.openlocfilehash: 77655e2e040b6a14a5c82151dac451e8373ea674
ms.sourcegitcommit: ae6d47b09a439cd0e13180f5e89510e3e347fd47
ms.translationtype: MT
ms.contentlocale: zh-TW
ms.lasthandoff: 02/08/2021
ms.locfileid: "99876975"
---
# <a name="threads-view-in-the-concurrency-visualizer"></a>並行視覺化檢視中的執行緒檢視

[執行緒] 檢視是並行視覺化檢視中最詳細且功能豐富的檢視。 在 [執行緒] 檢視中，您可以識別哪些執行緒正在執行區段期間執行程式碼，並分析執行緒是在執行中，還是因為同步處理、I/O 或其他原因而封鎖。 [執行緒] 檢視報表也會分析呼叫堆疊樹狀結構執行和解除封鎖執行緒。

當執行緒正在執行時，並行視覺化檢視會收集範例。 當執行緒停止執行時，視覺化檢視會檢查該執行緒的所有作業系統環境切換事件。 發生環境切換可能是因為：

- 同步處理原始物件封鎖執行緒。
- 執行緒配量期間已過。
- 執行緒產生封鎖 I/O 要求。

並行視覺化檢視會分類執行緒與環境切換事件，並搜尋已知封鎖 API 的執行緒呼叫堆疊。 它會在 [執行緒] 檢視左下方的作用中圖例中顯示執行緒分類。 在大部分情況下，您可以檢查對應到內容切換事件的呼叫堆疊，來識別封鎖事件的根本原因。

如果沒有任何呼叫堆疊符合，並行視覺化檢視會使用 [!INCLUDE[TLA#tla_mswin](../code-quality/includes/tlasharptla_mswin_md.md)] 所提供的等候原因。 不過，[!INCLUDE[TLA#tla_mswin](../code-quality/includes/tlasharptla_mswin_md.md)] 分類可能依據實作詳細資料而定，並不一定能反映使用者意圖。 例如，[!INCLUDE[TLA#tla_mswin](../code-quality/includes/tlasharptla_mswin_md.md)] 會將原生輕型 Reader-Writer 鎖定的封鎖等候原因報告為 I/O，而不是同步處理。

[執行緒] 檢視也會顯示執行緒之間的相依性。 例如，如果您識別在同步處理物件上封鎖的執行緒，則可以找到將其解除封鎖的執行緒。 當解除封鎖執行緒解除封鎖另一個執行緒時，您可以檢查解除封鎖執行緒的呼叫堆疊。

您可以使用 [執行緒] 檢視來：

- 識別應用程式的使用者介面 (UI) 在某些執行階段沒有回應的原因。
- 判斷花費在封鎖同步處理、I/O、分頁錯誤和其他事件的時間量。
- 探索受到系統上其他執行中處理序的干擾程度。
- 識別平行執行的負載平衡問題。
- 尋找延展性較差或不存在的原因。 比方說，為什麼當多個邏輯核心可供使用時，平行應用程式的效能無法改善。
- 了解應用程式中的並行程度以協助平行處理。
- 識別在背景工作執行緒與執行的關鍵路徑之間的相依性。

## <a name="use-threads-view"></a>使用 [執行緒] 檢視

若要啟動並行視覺化，請選取 [**分析**  >  **並行視覺化**]，然後選取一個選項，例如 [**啟動新的進程**]。

並行視覺化檢視會啟動應用程式並收集追蹤資料，直到您選取 [停止收集] 為止。 然後，視覺化檢視就會分析追蹤資料，並在追蹤報表頁面上顯示結果。

選取報表左上方的 [執行緒] 索引標籤來開啟 [執行緒] 檢視。

![執行緒視圖](../profiling/media/threadsviewnarrowing.png "執行緒檢視")

選取時間間隔和要啟動效能分析的執行緒。

## <a name="timeline-analysis"></a>時間軸分析

[執行緒] 檢視的上半部是時間軸。 時間軸顯示處理序中所有執行緒和主機電腦上所有實體磁碟裝置的活動。 其也顯示 GPU 活動和標記事件。

在時間軸上，X 軸是時間，而 Y 軸上有幾個通道：

- 系統上的每個磁碟機各有兩個 I/O 通道，一個通道用來讀取，而另一個用來寫入。
- 處理序中的每個執行緒各有一個通道。
- 標記通道，如果在追蹤中有標記事件。 標記通道一開始會出現在產生這些事件的執行緒通道下。
- GPU 通道。

一開始會依照執行緒建立的順序排列，因此第一個是主要的應用程式執行緒。 在 [排序依據] 下拉式清單中選取另一個選項，依照另一個準則來排序執行緒，例如 [執行]。

時間軸色彩表示指定時間的執行緒狀態。 綠色區段表示執行中，紅色區段表示遭封鎖進行同步處理、黃色區段表示遭到先佔，而紫色區段表示忙於裝置 I/O。

您可以放大以檢視更多詳細資料，或縮小以檢視更長的時間間隔。 請選取圖形上的區段和點，取得有關分類、開始時間、延遟及呼叫堆疊狀態的詳細資料。

請使用此時間軸，檢查平行迴圈或並行工作中相關執行緒之間的工作平衡。 如果完成某個執行緒所花的時間比其他執行緒更長，可能會造成工作分配不均。 您可以在執行緒之間更平均地分配工作，來改善應用程式的效能。

如果在某個時間點只有一個執行緒正在執行，則應用程式可能未充分利用系統上的並行處理能力。 您可以使用時間軸圖形，檢查執行緒之間的相依性，以及封鎖和遭封鎖執行緒之間的暫時關聯性。 若要重新排列執行緒，請選取執行緒，然後在工具列上選取向上或向下圖示。

您可以隱藏未正常運作或完全遭到封鎖的執行緒，因為其統計資料無關緊要，而且可能會塞滿報表。 請透過選取執行緒名稱，然後選取工具列上的 **隱藏選取的執行緒** 或 **隱藏所選執行緒以外的所有項目** 圖示來隱藏執行緒。 若要識別要隱藏的執行緒，請選取左下方的 [個別執行緒摘要] 連結。 您可以隱藏在 [個別執行緒摘要] 圖形中沒有活動的執行緒。

### <a name="thread-execution-details"></a>執行緒執行詳細資料
若要取得執行區段的詳細資訊，請選取時間軸中綠色區段上的點。 並行視覺化檢視會在選取點上方顯示黑色插入號，並在下方窗格的 [目前] 索引標籤上顯示其呼叫堆疊。 您可以在執行區段上選取多個點。

>[!NOTE]
>如果區段的持續時間少於一毫秒，並行視覺化檢視可能無法解析執行區段上的選取範圍。

若要取得目前所選取時間範圍內所有未隱藏執行緒的執行分析，請選取圖例左下方的 [執行]。

### <a name="thread-blocking-details"></a>執行緒封鎖詳細資料
若要取得執行緒上特定區域的相關資訊，請將滑鼠指標移至時間軸的該區域上方，以顯示工具提示。 工具提示包含分類、開始時間和延遲等資訊。 選取區域，在下方窗格的 [目前] 索引標籤中顯示該時間點的呼叫堆疊。 該窗格也會顯示分類、延遲、封鎖 API (如果有的話) 與解除封鎖執行緒 (如果有的話)。 您可以藉由檢查呼叫堆疊來判斷執行緒封鎖事件的根本原因。

執行路徑可能有多個封鎖事件。 若要更快速地封鎖分類並找到問題區域來進行檢查，請選取圖例左側的封鎖分類。

### <a name="dependencies-between-threads"></a>執行緒之間的相依性
並行視覺化檢視會顯示執行緒之間的相依性，以便您判斷遭封鎖執行緒嘗試執行的作業，以及將其啟用來執行的其他執行緒。

若要判斷將另一個執行緒解除封鎖的是哪一個執行緒，請選取時間軸上的封鎖區段。 如果並行視覺化檢視可以判斷解除封鎖執行緒，會在解除封鎖執行緒和封鎖區段後面的執行區段之間繪製一條線。 選取下方窗格中的 [解除封鎖堆疊] 索引標籤，查看相關的呼叫堆疊。

## <a name="profile-reports"></a>設定檔報告
時間軸圖形下方是一個窗格，其中包含 [分析報表]、[目前] 和 [解除封鎖堆疊] 報表索引標籤。 當您變更時間軸和執行緒選取範圍時，會自動更新報表。 進行大規模追蹤時，可能無法在計算更新時暫時使用報表窗格。

### <a name="profile-report-tab"></a>[分析報表] 索引標籤

[分析報表] 有兩個篩選條件：

- 若要篩選出花費時間較少的呼叫樹狀結構項目，請在 [減少雜訊] 欄位中鍵入介於 0 到 99% 之間的篩選值。 預設值為 2%。
- 若只要檢視您程式碼的呼叫樹狀結構，請選取 [Just My Code] 核取方塊。 若要檢視所有的呼叫樹狀結構，請清除核取方塊。

[分析報表] 索引標籤會以圖例顯示分類和連結的報表。 若要顯示報表，請選取左側的其中一個項目：

- **執行**：[執行] 報表會顯示應用程式花費的執行時間解析。

  若要找出執行時間花費在哪一行程式碼，請展開呼叫樹狀結構，並在呼叫樹狀結構項目的捷徑功能表上，選取 [檢視原始檔] 或 [檢視呼叫位置]。 [檢視原始檔] 會找到執行的那一行程式碼。 [檢視呼叫位置] 會找到呼叫所執行那一行的程式碼行。 如果呼叫位置只有一行，則會醒目提示其程式碼。 如果有多個呼叫位置，請在對話方塊中選取所需的呼叫位置，然後選取 [移至原始檔]。 找到有最多執行個體、花費最多時間 (或兩者) 的呼叫位置通常最有用。 如需詳細資訊，請參閱 [執行設定檔報表](../profiling/execution-profile-report.md)。

- **同步處理**：[同步處理] 報表顯示負責同步處理區塊的呼叫，以及每個呼叫堆疊的總封鎖時間。 如需詳細資訊，請參閱 [同步處理時間](../profiling/synchronization-time.md)。

- **I/O**：[I/O] 報表顯示負責 I/O 區塊的呼叫，以及每個呼叫堆疊的總封鎖時間。 如需詳細資訊，請參閱 [I/O 時間 (執行緒檢視)](../profiling/i-o-time-threads-view.md)。

- **睡眠**：[睡眠] 報表顯示負責睡眠區塊的呼叫，以及每個呼叫堆疊的總封鎖時間。 如需詳細資訊，請參閱 [睡眠時間](../profiling/sleep-time.md)。

- **記憶體管理**：[記憶體管理] 報表會顯示出現記憶體管理區塊的呼叫，以及每個呼叫堆疊的總封鎖時間。 請使用這項資訊來識別有過多分頁或記憶體回收問題的區域。  如需詳細資訊，請參閱 [記憶體管理時間](../profiling/memory-management-time.md)。

- **先佔**：[先佔] 報表會顯示系統上的處理序先佔目前處理序的位置，以及取代目前處理序中執行緒的個別執行緒。 您可以使用這項資訊來識別要對先佔負最大責任的處理序和執行緒。 如需詳細資訊，請參閱 [搶先時間](../profiling/preemption-time.md)。

- **UI 處理**：[UI 處理] 報表顯示負責 UI 處理區塊的呼叫，以及每個呼叫堆疊的總封鎖時間。 如需詳細資訊，請參閱 [UI 處理時間](../profiling/ui-processing-time.md)。

- **個別執行緒摘要**：選取 [個別執行緒摘要] 可顯示一個圖表，該圖表會顯示目前所選取時間間隔的執行緒狀態。 以色彩編碼的資料行顯示每個執行緒花費在執行、遭封鎖、I/O 及其他狀態的總時間。 執行緒標示在底部。 當您在時間軸圖形中調整縮放層級時，會自動更新此圖形。

  在一些縮放層級中，此圖形可能不會顯示某些執行緒。 發生這種情況時，在右側會出現省略符號 (**...**)。 如果您想要的執行緒並未出現，您可以隱藏其他執行緒。 如需詳細資訊，請參閱 [每個執行緒摘要報表](../profiling/per-thread-summary-report.md)。

- **磁碟作業**：選取 [磁碟作業] 可顯示與目前處理序的磁碟 I/O 相關的處理序和執行緒，其所接觸的檔案 (例如，載入的 DLL)、一共讀取多少個位元組以及其他資訊。 您可以使用此報表來評估執行期間花費在存取檔案的時間，尤其是當處理序似乎為 I/O 繫結時。 如需詳細資訊，請參閱 [磁片作業報告](../profiling/disk-operations-report-threads-view.md)。

### <a name="current-tab"></a>目前索引標籤
此索引標籤會顯示在時間軸圖形的執行緒區段上所選取時間點的呼叫堆疊。 顯示的呼叫堆疊會經過修剪，只顯示與您的應用程式相關的活動。

### <a name="unblocking-stack-tab"></a>[解除封鎖堆疊] 索引標籤
此索引標籤會顯示哪一個執行緒解除封鎖了選取的執行緒，以及解除封鎖呼叫堆疊。

## <a name="see-also"></a>另請參閱
- [並行視覺化檢視](../profiling/concurrency-visualizer.md)
