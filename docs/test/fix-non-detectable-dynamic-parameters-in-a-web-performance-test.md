---
title: " (web 效能測試) 修正無法偵測的動態參數"
description: 瞭解 web 效能測試錄製器和播放引擎如何自動處理最常見的動態參數類型。
ms.custom: SEO-VS-2020
ms.date: 10/19/2016
ms.topic: how-to
helpviewer_keywords:
- walkthroughs, load tests
- load tests, walkthroughs
- load tests, correlating dynamic parameters
ms.assetid: 92dff25c-36ee-4135-acdd-315c4962fa11
author: mikejo5000
ms.author: mikejo
manager: jillfra
ms.openlocfilehash: 9f670c9cf543ae209ebed63ce185fadfbbe253d0
ms.sourcegitcommit: 105e7b5a486262bc92939980383ceee068098a11
ms.translationtype: MT
ms.contentlocale: zh-TW
ms.lasthandoff: 12/30/2020
ms.locfileid: "97815720"
---
# <a name="fix-non-detectable-dynamic-parameters-in-a-web-performance-test"></a>在 Web 效能測試中修正無法偵測的動態參數

有些網站使用動態參數來處理其部分 Web 要求。 動態參數是每次使用者執行應用程式時將重新產生值的參數。 工作階段 ID 即為動態參數的一例。 工作階段 ID 通常每隔 5 到 30 分鐘就會變更一次。 Web 效能測試錄製器和播放引擎會自動處理最常見類型的動態參數：

- 在 Cookie 值中設定的動態參數值。 Web 效能測試引擎會在播放期間自動處理這些值。

- 在 HTML 頁面的隱藏欄位中設定的動態參數值，例如 ASP.NET 檢視狀態。 錄製器會將隱藏欄位擷取規則加入測試，來自動處理這些值。

- 設定為查詢字串或表單張貼參數的動態參數值。 這些是在錄製 Web 效能測試之後，透過動態參數偵測來處理。

有部分類型的動態參數是偵測不到的。 由於每次執行測試時動態的值可能會不同，未偵測到的動態參數將會在您執行 Web 效能測試時造成測試失敗。 若要正確處理這些參數，您可以在 Web 效能測試中，手動將擷取規則加入至動態參數。

[!INCLUDE [web-load-test-deprecated](includes/web-load-test-deprecated.md)]

## <a name="create-and-run-a-web-app-with-dynamic-parameters"></a>建立並執行具有動態參數的 Web 應用程式

為了示範可偵測及無法偵測到的動態參數，我們將會建立一個簡單的 ASP.NET Web 應用程式，其中有內含一些控制項和一些自訂程式碼的三個 Web 表單。 我們將會了解如何隔離動態參數以及如何處理它們。

1. 建立名為 **DynamicParameterSample** 的新 ASP.NET 專案。

     ![建立空白的 ASP.NET Web 應用程式專案](../test/media/web_test_dynamicparameter_aspproject.png)

2. 加入名為 *Querystring.aspx* 的 Web 表單。

3. 在設計檢視中，將 HiddenField 拖曳到頁面上，然後將 (ID) 屬性的值變更為 HiddenFieldSessionID。

     ![加入 HiddenField](../test/media/web_test_dynamicparameter_hiddenfield.png)

4. 變更為 Querystring 頁面的來源檢視，並加入下面反白顯示的 ASP.NET 和 JavaScript 程式碼，用來產生模擬的工作階段 ID 動態參數：

    ```html
    <head runat="server">
    <title>JavaScript dynamic property correlation sample</title><script type="text/javascript" language="javascript">    <!--        function jScriptQueryString()         {            var Hidden = document.getElementById("HiddenFieldSessionID");            var sessionId = Hidden.value;            window.location = 'JScriptQuery.aspx?CustomQueryString=jScriptQueryString___' + sessionId;         }    //--></script>
    </head>
    <body>
        <form id="form1" runat="server">
        <div>
             <a name="QuerystringHyperlink" href="ASPQuery.aspx?CustomQueryString=ASPQueryString___<%= Session.SessionID %>">Dynamic querystring generated by ASP.net</a>         <br/>         <br/>         <a href="javascript:jScriptQueryString()">Dynamic querystring generated by javascript </a>
        </div>
        <asp:HiddenField ID="HiddenFieldSessionID" runat="server" />
        </form>
    </body>
    </html>
    ```

5. 開啟 *Querystring.aspx.cs* 檔案，並將下列反白顯示的程式碼加入至 Page_Load 方法：

    ```csharp
    public partial class Querystring : System.Web.UI.Page
    {
        protected void Page_Load(object sender, EventArgs e)
        {
            Session.Add("Key", "Value");HiddenFieldSessionID.Value = Session.SessionID;
        }
    }
    ```

6. 加入第二個名為 *ASPQuery.aspx* 的 Web 表單。

7. 在設計檢視中，將 [標籤] 拖曳到頁面上，然後將其 [(ID)] 屬性的值變更為 **IndexLabel**。

     ![將標籤加入至 Web Form](../test/media/web_test_dynamicparameter_label.png)

8. 將 [HyperLink] 拖曳至頁面上，並將其 [Text] 屬性值變更為 **Back**。

     ![將超連結加入至 Web Form](../test/media/web_test_dynamicparameter_hyperlink.png)

9. 選擇 [NavigationURL] 屬性的 [(...)]。

     ![編輯 NavigateURL 屬性](../test/media/web_test_dynamicparameter_hyperlink_navurl.png)

     選取 [Querystring.aspx]。

     ![選擇要成為 Querystring.aspx 的 URL](../test/media/web_test_dynamicparameter_hyperlink_navurl2.png)

10. 開啟 *ASPQuery.aspx.cs* 檔案，並將下列反白顯示的程式碼加入至 Page_Load 方法：

    ```csharp
    protected void Page_Load(object sender, EventArgs e)
            {
                int index;            string qstring;            string dateportion;            string sessionidportion;            qstring = Request.QueryString["CustomQueryString"];            index = qstring.IndexOf("___");            dateportion = qstring.Substring(0, index);            index += 3;            sessionidportion = qstring.Substring(index, qstring.Length - index);            if (sessionidportion != Session.SessionID)            {                Response.StatusCode = 401;                IndexLabel.Text = "Failure!  Invalid querystring parameter found.";            }            else            {                IndexLabel.Text = "Success.  Dynamic querystring parameter was found.";            }            IndexLabel.Text += "<br>\r\n";
            }
    ```

11. 加入第三個名為 *JScriptQuery.aspx* 的 Web 表單。

     正如我們對第二個頁面所做的，拖曳 [標籤] 到表單上，將其 [(ID)] 屬性設定為 **IndexLabel** 並拖曳 [Hyperlink] 到表單上，將其 [Text] 屬性設定為 **Back**，再將其 [NavigationURL] 屬性設定為 **Querystring.aspx**。

     ![加入和設定第三個 Web Form](../test/media/web_test_dynamicparameter_addwebform3.png)

12. 開啟 *JScriptQuery.aspx.cs* 檔案，並將下列反白顯示的程式碼加入至 Page_Load 方法：

    ```csharp
    protected void Page_Load(object sender, EventArgs e)
            {
                int index;            string qstring;            string dateportion;            string sessionidportion;            qstring = Request.QueryString["CustomQueryString"];            index = qstring.IndexOf("___");            dateportion = qstring.Substring(0, index);            index += 3;            sessionidportion = qstring.Substring(index, qstring.Length - index);            if (sessionidportion != Session.SessionID)            {                Response.StatusCode = 401;                IndexLabel.Text = "Failure!  Invalid querystring parameter found.";            }            else            {                IndexLabel.Text = "Success.  Dynamic querystring parameter was found.";            }            IndexLabel.Text += "<br>\r\n";
            }
    ```

13. 儲存專案。

14. 在 [方案總管] 中，將 *Querystring.aspx* 設定為起始頁。

     ![將 Querystring.aspx 設定為起始頁](../test/media/web_test_dynamicparameter_setstartpage.png)

15. 按下 **Ctrl** + **F5** 以在瀏覽器中執行 web 應用程式。 複製 URL。 當您錄製測試時，您將會需要它。

16. 嘗試兩個連結。 它們應該都會顯示訊息「成功。 Dynamic querystring parameter found."

     ![執行 Web 應用程式](../test/media/web_test_dynamicparameter_runapp.png)

     ![成功！](../test/media/web_test_dynamicparameter_runapp2.png)

## <a name="create-a-web-performance-test"></a>建立 Web 效能測試

1. 將 Web 效能和負載測試專案加入至您的方案。

     ![加入 Web 效能和負載測試專案](../test/media/web_test_dynamicparameter_addtestproject.png)

2. 將 WebTest1.webtest 重新命名為 DynamicParameterSampleApp.webtest。

     ![重新命名 Web 效能測試](../test/media/web_test_dynamicparameter_renametest.png)

3. 錄製測試。

     ![錄製 Web 效能測試](../test/media/web_test_dynamicparameter_recordtest.png)

4. 將您要測試之網站的 URL 複製並貼入瀏覽器中。

     ![從正在測試的網站貼上 URL](../test/media/web_test_dynamicparameter_recordtest2.png)

5. 瀏覽 Web 應用程式。 選擇 ASP.NET 連結、[上一步] 連結，然後選擇 javascript 連結及 [上一步] 連結。

     當您巡覽 Web 應用程式時，Web 測試錄製器會顯示 HTTP 要求和回應 URL。

6. 選擇測試錄製器上的 [停止] 按鈕。

     偵測動態參數的對話方塊會顯示進度列，以呈現收到的 HTTP 回應中的參數偵測狀態。

7. 在 ASPQuery 頁面中，會自動偵測 CustomQueryString 的動態參數。 不過，在 JScriptQuery 頁面中未偵測到 CustomQueryString 的動態參數。

     選擇 [確定]，將擷取規則加入至 *Querystring.aspx*，將它繫結至 ASPQuery 頁面。

     ![提升偵測到的動態參數](../test/media/web_test_dynamicparameter_promotedialog.png)

     擷取規則會加入至 *Querystring.aspx* 的第一個要求。

     ![擷取規則已加入至要求](../test/media/web_test_dynamicparameter_autoextractionrule.png)

     展開 *ASPQuery.aspx* 的要求樹狀中的第二個要求，並且注意 CustomQueryString 的值已繫結程序至擷取規則。

     ![CustomQueryString 已繫結至擷取規則](../test/media/web_test_dynamicparameter_autoextractionrule2.png)

8. 儲存測試。

## <a name="run-the-test-to-isolate-the-non-detected-dynamic-parameter"></a>執行測試找出未偵測到的動態參數

1. 執行測試。

     ![執行 Web 效能測試](../test/media/web_test_dynamicparameter_runtest.png)

2. 針對 *JScriptQuery.aspx* 頁面的第四個要求失敗。 移至 Web 測試。

     ![測試結果中的動態參數錯誤](../test/media/web_test_dynamicparameter_runresults.png)

     *JScriptQuery.aspx* 要求節點會在編輯器中反白顯示。 展開節點就會注意到 CustomQueryString 的 "1v0yhyiyr0raa2w4j4pwf5zl" 部分似乎是動態的。

     ![CustomQueryString 中的疑似動態參數](../test/media/web_test_dynamicparameter_runresults2.png)

3. 返回 [Web 效能測試結果檢視器]，並選取失敗的 *JScriptQuery.aspx* 頁面。 然後，選取要求索引標籤，確認已清除 [顯示未經處理資料] 核取方塊，向下捲動並對 CustomQueryString 選取快速尋找。

     ![Web 效能文字結果檢視器中 [要求] 索引標籤的螢幕擷取畫面。 選取 QueryString 參數，QuickFind 會在內容功能表上反白顯示。](../test/media/web_test_dynamicparameter_runresultsquckfind.png)

4. 我們從查看 [測試編輯器] 得知， *jscriptquery.aspx .aspx* 要求的 CustomQueryString 被指派值： `jScriptQueryString___1v0yhyiyr0raa2w4j4pwf5zl` ，而且可疑的動態部分為 "1v0yhyiyr0raa2w4j4pwf5zl"。 在 [尋找目標] 下拉式清單中，移除搜尋字串的可疑部分。 字串應該是 "CustomQueryString=jScriptQueryString___"。

     動態參數的值會在有錯誤之要求前面的其中一個要求中指派。 因此，選取 [向上搜尋] 核取方塊並選擇 [找下一個]，直到您在 [要求] 面板中看見反白顯示之 *Querystring.aspx* 的先前要求。 這應該會在選擇三次 [找下一個] 之後出現。

     ![Web 效能文字結果檢視器的螢幕擷取畫面。 選取查詢字串，[尋找] 對話方塊會顯示 [SearchUp]，並尋找下一個選取的對話方塊。](../test/media/web_test_dynamicparameter_runresultsquckfind4.png)

     如 [回應] 索引標籤以及稍早實作的 JavaScript 中所示，指派給查詢字串參數 CustomQueryString 的值為 " jScriptQueryString___"，而且會與 var sessionId 傳回的值串連。

    ```javascript
    function jScriptQueryString()          {             var Hidden = document.getElementById("HiddenFieldSessionID");             var sessionId = Hidden.value;             window.location = 'JScriptQuery.aspx?CustomQueryString=jScriptQueryString___' + sessionId;          }

    ```

     現在我們知道發生錯誤的位置，也知道需要為 sessionId 擷取值。 不過，擷取值僅限文字，因此需要嘗試尋找顯示 sessionId 實際值的字串，才能進一步找出錯誤。 查看程式碼，就可看見 var sessionId 等於 HiddenFieldSessionID 傳回的值。

5. 在 HiddenFieldSessionID 上使用快速尋找，清除 [向上搜尋] 核取方塊和選取目前要求。

     ![針對 HiddenFieldSession 使用快速尋找](../test/media/web_test_dynamicparameter_runresultsquckfindhiddensession.png)

     請注意，傳回的值與原始 Web 效能測試錄製的字串並不相同。 對於這個測試回合，傳回的值為 "5w4v3yrse4wa4axrafykqksq"，而在原始錄製中，值為 "1v0yhyiyr0raa2w4j4pwf5zl"。 因為值與原始錄製的值不相符，所以產生錯誤。

6. 由於我們必須修正原始錄製的動態參數，請選擇工具列中的記錄結果。

     ![選取 [錄製的結果]](../test/media/web_test_dynamicparameter_recordedresult.png)

7. 在錄製的結果中，選取第三項要求，這與您在測試回合結果中找出的 *Querystringrequest.aspx* 要求相同。

     ![在錄製的結果中選擇相同的要求](../test/media/web_test_dynamicparameter_recordedresultsselectnode.png)

     選擇回應索引標籤，向下捲動並選擇先前隔離的原始動態參數值 1v0yhyiyr0raa2w4j4pwf5zl，並且加入擷取規則。

     ![為動態參數加入擷取規則](../test/media/web_test_dynamicparameter_recordedresultaddextractionrule.png)

     新的擷取規則已加入至 *Querystring.aspx* 要求，而且已獲指派 "Param0" 的值。

     如果對話方塊通知我們找到可讓所擷取文字將參數繫結至其中的相符項目，則選擇 [是]。

     ![已建立擷取規則](../test/media/web_test_dynamicparameter_addextractiondialog.png)

8. 選擇 [尋找下一個]。 需要變更的第一個符合項目，這是 JScriptQuery 頁面中 CustomQueryString 的參數。

     ![尋找並取代參數的文字](../test/media/web_test_dynamicparameter_addextractionfindreplace.png)

9. 選擇 [取代]。

     ![以參數取代文字](../test/media/web_test_dynamicparameter_addextractionfindreplace2.png)

     *JScriptQuery.aspx* 要求底下的 QueryString 參數會以新的內容參數更新：CustomQueryString=jScriptQueryString___{{Param0}}。

     ![參數已套用至查詢字串](../test/media/web_test_dynamicparameter_addextractionfindreplace3.png)

10. 關閉 [尋找和取代] 對話方塊。 請注意要求樹狀結構中，相互關聯之偵測到的動態參數和未偵測到的動態參數之間相似的結構。

     ![偵測到的和相互關聯的動態參數](../test/media/web_test_dynamicparameter_conclusion.png)

11. 執行測試。 它現在會執行，而不會失敗。

## <a name="qa"></a>問答集

### <a name="q-can-i-re-run-dynamic-parameter-detection-if-my-web-app-gets-modified"></a>問：如果 Web 應用程式有修改，我可以重新執行動態參數偵測嗎？

**答：** 可以，請使用下列程序：

1. 選擇工具列中的 [將動態參數升至 Web 測試參數] 按鈕。

     在偵測程序完成後，如果偵測到動態參數，即會出現 [將動態參數升至 Web 測試參數] 對話方塊。

     [動態參數] 欄下會列出動態參數。 [擷取回應中的參數] 和 [繫結至要求] 欄下會分別列出將從中擷取動態參數的要求，以及動態參數會繫結至的要求。

     如果您選擇 [將動態參數升至 Web 測試參數] 對話方塊中的動態參數，[Web 效能測試編輯器] 要求樹狀目錄中會反白顯示兩個要求。 第一個要求是要將擷取規則加入至的要求。 第二個要求是所擷取的值要繫結至的要求。

2. 選取或清除您要自動相互關聯之動態參數旁邊的核取方塊。 依預設會核取所有動態參數。

### <a name="q-do-i-need-to-configure-visual-studio-to-detect-dynamic-parameters"></a>問：我是否需要設定 Visual Studio 來偵測動態參數？

**答：** 預設 Visual Studio 組態是在您錄製 Web 效能測試時偵測動態參數。 但如果您的 Visual Studio 選項已設定成不偵測動態參數，或是受測的 Web 應用程式會由其他動態參數修改，您仍然可以從 Web 效能測試編輯器中執行動態參數偵測。
